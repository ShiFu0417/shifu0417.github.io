<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trip 2026</title>
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip 2026">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/201/201623.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    padding: { 
                        'safe-top': 'env(safe-area-inset-top)', 
                        'safe-bottom': 'env(safe-area-inset-bottom)' 
                    },
                    margin: { 
                        'safe-bottom': 'env(safe-area-inset-bottom)' 
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; 
            background-color: #F2F2F7;
            /* ç¢ºä¿èƒŒæ™¯è‰²å»¶ä¼¸åˆ°å…¨è¢å¹• */
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: #000000; }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* Accordion transition */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-content.open { max-height: 8000px; transition: max-height 0.8s ease-in; }
        .rotate-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-icon.open { transform: rotate(90deg); }
        
        /* Apple UI List Group Style */
        .apple-list-group {
            background-color: white;
            border-radius: 22px;
            overflow: hidden;
        }
        .dark .apple-list-group {
            background-color: #1C1C1E;
        }
        .apple-list-item {
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }
        .dark .apple-list-item {
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        .apple-list-item:last-child { border-bottom: none; }

        @media (prefers-color-scheme: dark) {
            iframe.map-frame { filter: invert(90%) hue-rotate(180deg); }
        }
        
        /* Safe Area Utilities */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-pb-with-margin { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        .safe-bottom-pos { bottom: calc(1.5rem + env(safe-area-inset-bottom)); }

        /* Transport Line */
        .timeline-line {
            position: absolute;
            left: 23px; /* Align with icon center */
            top: 40px;
            bottom: -20px;
            width: 2px;
            background-color: #E5E5EA;
        }
        .dark .timeline-line { background-color: #38383A; }
        
        .timeline-line-dashed {
            position: absolute;
            left: 23px;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dashed #C7C7CC;
        }
        .dark .timeline-line-dashed { border-left-color: #48484A; }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Data ---
        const CITY_COORDS = { 'Taipei': {lat:25.033,lng:121.565}, 'Paris': {lat:48.856,lng:2.352}, 'Malta': {lat:35.937,lng:14.375}, 'Venice': {lat:45.440,lng:12.315}, 'Florence': {lat:43.769,lng:11.255}, 'Rome': {lat:41.902,lng:12.496} };

        // Helper for Coords
        const c = (lat, lng) => ({lat, lng});

        // Item Types: 'visit' (default), 'trans' (transport), 'flight' (flight)
        const TRIP = [
            { id:'d0', date:'1/31', wk:'é€±å…­', city:'Taipei', t:'20Â°', c:'Cloudy', tl:[
                {type: 'visit', tm:'23:00',ti:'TPE â†’ DXB',d:'Emirates EK367 | æ¡ƒåœ’ T2 å‡ºç™¼ (è½‰æ©Ÿ 2h 55m)',loc:'Taoyuan Airport Terminal 2', coords: c(25.079, 121.234), l:[{t:'èˆªç­ç‹€æ…‹',u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}]}
            ]},
            { id:'d1', date:'2/1', wk:'é€±æ—¥', city:'Paris', t:'6Â°', c:'Rain', tl:[
                {type: 'visit', tm:'12:25',ti:'æŠµé”å·´é» CDG',d:'Emirates EK073 | æŠµé” Terminal 2C',loc:'CDG Airport Terminal 2C', coords: c(49.009, 2.547)},
                {type: 'trans', mode: 'RER', ti:'æ©Ÿå ´å¾€å¸‚å€', d:'RER B: CDG -> Chatelet Les Halles', detail:'ç¥¨åƒ¹ â‚¬11.8 / è»Šç¨‹ç´„ 35-40 åˆ†é˜ã€‚äº¦å¯å« Uber (â‚¬52-65)ã€‚', icon:'ğŸš†'},
                {type: 'visit', tm:'14:30',ti:'Check-in',d:'15 Rue des Halles. è²· Navigo Easy å¡ (ç©ºå¡â‚¬2)',loc:'15 Rue des Halles', coords: c(48.860, 2.346), desc:'ä½æ–¼å¸‚ä¸­å¿ƒï¼Œäº¤é€šä¾¿åˆ©ã€‚'},
                {type: 'trans', mode: 'Metro', ti:'å¾€å·´å£«åº•', d:'Metro 1è™Ÿç·š: Chatelet -> Bastille', detail:'ä½¿ç”¨ Navigo Easy æˆ– Ticket t+ã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'PM',ti:'Bastille æ¼«æ­¥',d:'Bastille å»£å ´ã€Village St. Paul',loc:'Place de la Bastille', coords: c(48.853, 2.369), desc:'å……æ»¿æ´»åŠ›çš„å€åŸŸï¼Œæœ‰è¨±å¤šå¤è‘£åº—å’Œæ­·å²éºè·¡ã€‚'}
            ]},
            { id:'d2', date:'2/2', wk:'é€±ä¸€', city:'Paris', t:'7Â°', c:'Cloudy', tl:[
                {type: 'trans', mode: 'Metro', ti:'å¾€ç¾…æµ®å®®', d:'Metro 1/7è™Ÿç·š -> Palais Royal-MusÃ©e du Louvre', detail:'å¾ Carrousel å…¥å£é€²å…¥é¿é–‹äººæ½®ã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'09:00',ti:'ç¾…æµ®å®®',d:'Carrouselå…¥å£é€². çœ‹è’™å¨œéº—è',loc:'Carrousel du Louvre', coords: c(48.862, 2.333), imp:1, desc:'é‡é»ï¼šDenon é¤¨ (è’™å¨œéº—è, å‹åˆ©å¥³ç¥)ã€‚é€±äºŒä¼‘é¤¨ã€‚', l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://www.ticketlouvre.fr/'}]},
                {type: 'visit', tm:'Lunch',ti:'Le Fumoir',d:'è³ªæ„Ÿé¤é…’é¤¨ (ç¾…æµ®å®®å°é¢)',loc:'Le Fumoir Paris', coords: c(48.860, 2.340), eat:1, menu:'é´¨èƒ¸, éŸƒé¼ç‰›è‚‰', tel:'+33 1 42 92 00 24'},
                {type: 'trans', mode: 'Walk', ti:'æ­¥è¡Œæˆ–åœ°éµ', d:'æ­¥è¡Œç¶“ Tuileries æˆ–æ­åœ°éµå¾€æ­ŒåŠ‡é™¢', detail:'è·é›¢ç´„ 1.2kmï¼Œæ­¥è¡Œ 15 åˆ†é˜ã€‚', icon:'ğŸš¶'},
                {type: 'visit', tm:'PM',ti:'æ­ŒåŠ‡é™¢ (OpÃ©ra Garnier)',d:'å·´æ´›å…‹å»ºç¯‰å·”å³°',loc:'Palais Garnier', coords: c(48.871, 2.331), desc:'ã€Šæ­ŒåŠ‡é­…å½±ã€‹èƒŒæ™¯ã€‚åƒè§€é–€ç¥¨ â‚¬15ã€‚'},
                {type: 'trans', mode: 'Metro', ti:'å¾€æ™šé¤', d:'Metro 9è™Ÿç·š: ChaussÃ©e d\'Antin -> Marcel Sembat', detail:'å‰å¾€ Boulogne åˆ†åº—åƒæµ·é®®ã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'Dinner',ti:'Pedra Alta',d:'å¿…åƒæµ·é®®ç›¤! Riz GrillÃ©',loc:'Pedra Alta Boulogne', coords: c(48.839, 2.239), eat:1, menu:'Riz GrillÃ© (æµ·é®®ç‡‰é£¯), Plateau Royal', tel:'+33 1 46 05 15 65'}
            ]},
            { id:'d3', date:'2/3', wk:'é€±äºŒ', city:'Paris', t:'5Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'RER', ti:'å¾€å‡¡çˆ¾è³½', d:'RER C (VICK): St-Michel -> Versailles ChÃ¢teau', detail:'è»Šç¨‹ç´„ 40 åˆ†é˜ã€‚è²·ä¾†å›ç¥¨ã€‚', icon:'ğŸš†'},
                {type: 'visit', tm:'09:00',ti:'å‡¡çˆ¾è³½å®®',d:'éœ€é ç´„ Passport ç¥¨ (å®®æ®¿+èŠ±åœ’)',loc:'Palace of Versailles', coords: c(48.804, 2.120), imp:1, desc:'å»ºè­°ç§Ÿé«˜çˆ¾å¤«çƒè»ŠéŠè¦½èŠ±åœ’ã€‚é€±ä¸€ä¼‘é¤¨ã€‚'},
                {type: 'trans', mode: 'RER', ti:'è¿”å›å¸‚å€', d:'RER C: Versailles -> Champ de Mars / Pont de l\'Alma', detail:'å‰å¾€éµå¡”èˆ‡éŠèˆ¹ç¢¼é ­ã€‚', icon:'ğŸš†'},
                {type: 'visit', tm:'PM',ti:'è‰¾è²çˆ¾éµå¡” & éŠèˆ¹',d:'Bateaux-Mouches (Pont de l\'Alma)',loc:'Bateaux-Mouches', coords: c(48.864, 2.301), desc:'æ­ä¹˜å¡ç´æ²³éŠèˆ¹ã€‚ç¢¼é ­ä½æ–¼ Pont de l\'Almaã€‚'}
            ]},
            { id:'d4', date:'2/4', wk:'é€±ä¸‰', city:'Paris', t:'6Â°', c:'Cloudy', tl:[
                {type: 'trans', mode: 'Metro', ti:'å¾€è’™é¦¬ç‰¹', d:'Metro 12è™Ÿç·š -> Abbesses', detail:'å‡ºç«™å¯çœ‹æ„›ä¹‹ç‰†ã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'AM',ti:'è’™é¦¬ç‰¹æ•£æ­¥ I',d:'æ„›ä¹‹ç‰† (Wall of Love) -> è–å¿ƒå ‚ (SacrÃ©-CÅ“ur)',loc:'SacrÃ©-CÅ“ur', coords: c(48.886, 2.343), desc:'å……æ»¿è—è¡“æ°£æ¯çš„å±±ä¸˜ï¼Œä¿¯ç°å·´é»å…¨æ™¯ã€‚'},
                {type: 'visit', tm:'Walk',ti:'è’™é¦¬ç‰¹æ•£æ­¥ II',d:'å°ä¸˜å»£å ´ -> ç‹¡å…”ä¹‹çªŸ -> ç«ç‘°ä¹‹å®¶',loc:'La Maison Rose', coords: c(48.888, 2.339), desc:'æ²¿è‘— Rue de lâ€™Abreuvoir æ•£æ­¥ï¼Œç¶“éé”åˆ©é”å»£å ´ (Place Dalida)ã€‚'},
                {type: 'visit', tm:'Walk',ti:'è’™é¦¬ç‰¹æ•£æ­¥ III',d:'ç©¿ç‰†äºº -> ç…é¤…ç£¨åŠ -> é›™é¢¨è»Šå’–å•¡é¤¨',loc:'CafÃ© des Deux Moulins', coords: c(48.884, 2.333), desc:'è‰¾èœœè‰çš„ç•°æƒ³ä¸–ç•Œæ‹æ”åœ°ã€‚æœ€å¾ŒæŠµé”ç´…ç£¨åŠã€‚'},
                {type: 'visit', tm:'Lunch',ti:'Breizh CafÃ©',d:'æ³•å¼å¯éº—é¤…',loc:'Breizh CafÃ©', coords: c(48.859, 2.362), eat:1, menu:'Classic Jambon Fromage, Cidre'},
                {type: 'trans', mode: 'Metro', ti:'å¾€ç™¾è²¨', d:'Metro 12è™Ÿç·š -> TrinitÃ© æˆ– æ­¥è¡Œ', detail:'å‰å¾€æ‹‰ä½›çˆºç™¾è²¨å€åŸŸã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'PM',ti:'æ‹‰ä½›çˆºç™¾è²¨',d:'Gourmeté¤¨è²·ä¼´æ‰‹ç¦®',loc:'Galeries Lafayette Haussmann', coords: c(48.873, 2.332), buy:1, desc:'å¿…å» Gourmet é¤¨ B1 è²· Pierre HermÃ©, éµè‚é†¬ã€‚'},
                {type: 'visit', tm:'Dinner',ti:'L\'Escargot Montorgueil',d:'ç™¾å¹´è¸ç‰›é¤å»³',loc:'L\'Escargot Montorgueil', coords: c(48.864, 2.347), eat:1, menu:'Escargots de Bourgogne'}
            ]},
            { id:'d5', date:'2/5', wk:'é€±å››', city:'Malta', t:'15Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Flight', ti:'é£›å¾€é¦¬çˆ¾ä»–', d:'EasyJet: CDG T2B (10:00) -> MLA (12:55)', detail:'å‰å¾€ CDG T2B æ­æ©Ÿã€‚', icon:'âœˆï¸'},
                {type: 'trans', mode: 'Car', ti:'æ©Ÿå ´å¾€ Sliema', d:'Bolt / Uber', detail:'è»Šè³‡ç´„ â‚¬15-20ã€‚äº¦å¯æ­ Bus X2 (â‚¬2)ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'14:00',ti:'Sliema Check-in',d:'47 TignÃ© Seafront',loc:'47 TignÃ© Seafront', coords: c(35.908, 14.508), desc:'æµ·æ™¯å…¬å¯“ï¼Œå°é¢å³æ˜¯ç“¦èŠå¡”ã€‚'},
                {type: 'trans', mode: 'Ferry', ti:'å¾€ç“¦èŠå¡”', d:'Sliema Ferry -> Valletta', detail:'ç¥¨åƒ¹ â‚¬1.50 (ä¾†å› â‚¬2.80)ã€‚', icon:'â›´ï¸'},
                {type: 'visit', tm:'PM',ti:'ç“¦èŠå¡”æ¼«æ­¥ I',d:'Triton Fountain -> City Gate -> Parliament',loc:'Valletta City Gate', coords: c(35.896, 14.509), desc:'æ­æ´²æœ€å°é¦–éƒ½ï¼Œä¸–ç•Œéºç”¢ã€‚'},
                {type: 'visit', tm:'15:30',ti:'Upper Barrakka Gardens',d:'çµ•ç¾å¤§æ¸¯æ™¯è§€',loc:'Upper Barrakka Gardens', coords: c(35.895, 14.512), desc:'å¯ä¿¯ç°ä¸‰å§å¦¹åŸã€‚'},
                {type: 'visit', tm:'16:00',ti:'è–ç´„ç¿°å¤§æ•™å ‚',d:'æ¥µè‡´å·´æ´›å…‹',loc:'St John\'s Co-Cathedral', coords: c(35.897, 14.512), imp:1, desc:'å¿…çœ‹å¡æ‹‰ç“¦å–¬åç•«ã€‚é–€ç¥¨ â‚¬15ï¼Œ16:15 æœ€å¾Œå…¥å ´ã€‚'},
                {type: 'visit', tm:'Walk',ti:'ç“¦èŠå¡”æ¼«æ­¥ II',d:'Grandmasterâ€™s Palace -> Lower Barrakka',loc:'Grandmaster\'s Palace', coords: c(35.898, 14.513), desc:'ç¶“é Victoria Gateï¼Œæ¬£è³èˆŠåŸå€é¢¨å…‰ã€‚'},
                {type: 'visit', tm:'Dinner',ti:'L\'Ancora or Ta\' Kris',d:'æ¨è–¦æ™šé¤',loc:'L\'Ancora Boutique Hotel', coords: c(35.908, 14.508), eat:1}
            ]},
            { id:'d6', date:'2/6', wk:'é€±äº”', city:'Malta', t:'16Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Car', ti:'å¾€ Mdina', d:'Uber / Bolt', detail:'ç´„ 20-30 åˆ†é˜ã€‚äº¦å¯æ­å…¬è»Š (202è™Ÿ)ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'AM',ti:'Mdina å¤åŸ',d:'æ¬ŠåŠ›éŠæˆ²æ‹æ”åœ° (å¯‚éœä¹‹åŸ)',loc:'Mdina Gate', coords: c(35.885, 14.403), imp:1, desc:'åƒè§€åŸé–€ã€ä¸»æ•™å ‚ã€‚'},
                {type: 'visit', tm:'Break',ti:'Fontanella Tea Garden',d:'åŸç‰†è›‹ç³•åº—',loc:'Fontanella Tea Garden', coords: c(35.886, 14.403), eat:1, menu:'å·§å…‹åŠ›è›‹ç³•, è‰è“å¡”'},
                {type: 'trans', mode: 'Car', ti:'å¾€ St. Julian\'s', d:'Uber / Bolt', detail:'å‰å¾€æµ·ç£å€ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'PM',ti:'St. Julian\'s & Balluta Bay',d:'ç†±é¬§æµ·ç£èˆ‡æ–°å“¥å¾·æ•™å ‚',loc:'Balluta Bay', coords: c(35.914, 14.491)},
                {type: 'visit', tm:'Dinner',ti:'Yana\'s or Tapea',d:'æ¨è–¦æ™šé¤',loc:'Tapea', coords: c(35.912, 14.490), eat:1}
            ]},
            { id:'d7', date:'2/7', wk:'é€±å…­', city:'Malta', t:'15Â°', c:'Cloudy', tl:[
                {type: 'trans', mode: 'Bus', ti:'å¾€ç¢¼é ­', d:'Bus 222: Sliema -> Cirkewwa', detail:'è»Šç¨‹ç´„ 1 å°æ™‚ã€‚', icon:'ğŸšŒ'},
                {type: 'trans', mode: 'Ferry', ti:'å¾€ Gozo', d:'Gozo Channel Line', detail:'èˆ¹ç¨‹ 25 åˆ†é˜ï¼Œç¥¨åƒ¹ â‚¬4.65 (å›ç¨‹ä»˜è²»)ã€‚', icon:'â›´ï¸'},
                {type: 'visit', tm:'AM',ti:'Victoria Citadel',d:'å³¶ä¸­å¿ƒåŸå ¡',loc:'The Citadel Victoria', coords: c(36.046, 14.239), desc:'Gozo åˆ¶é«˜é»ã€‚'},
                {type: 'trans', mode: 'Car', ti:'å¾€ Dwejra', d:'Uber / Bolt / Bus 311', detail:'å‰å¾€è¥¿æµ·å²¸ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'Noon',ti:'Dwejra & Inland Sea',d:'å…§æµ·æ­å°èˆ¹ (â‚¬4)',loc:'Dwejra Bay', coords: c(36.052, 14.191), desc:'è—çª—éºå€èˆ‡å…§æµ·å²©æ´é«”é©—ã€‚'},
                {type: 'trans', mode: 'Car', ti:'å¾€ç¥å»Ÿ', d:'Uber / Bolt / Bus 302', icon:'ğŸš—'},
                {type: 'visit', tm:'PM',ti:'Ggantija Temples',d:'å·¨çŸ³ç¥å»Ÿ',loc:'Ggantija Temples', coords: c(36.047, 14.269), imp:1, desc:'æ¯”é‡‘å­—å¡”é‚„å¤è€çš„ä¸–ç•Œéºç”¢ã€‚'},
                {type: 'visit', tm:'Sight',ti:'Xlendi Bay',d:'æµ·ç£æ™¯è‰²',loc:'Xlendi', coords: c(36.030, 14.217)}
            ]},
            { id:'d8', date:'2/8', wk:'é€±æ—¥', city:'Malta', t:'16Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Car', ti:'å¾€é­šå¸‚', d:'Uber / Bolt (é€±æ—¥å¸‚é›†)', detail:'å‰å¾€æ±å—éƒ¨æ¼æ‘ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'AM',ti:'Marsaxlokk é­šå¸‚',d:'é€±æ—¥é™å®š! æ‹å½©è‰²æ¼èˆ¹ Luzzu',loc:'Marsaxlokk Market', coords: c(35.841, 14.544), imp:1},
                {type: 'trans', mode: 'Car', ti:'å¾€è—æ´', d:'Uber / Bolt', detail:'ç´„ 15 åˆ†é˜è»Šç¨‹ã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'Noon',ti:'Blue Grotto (è—æ´)',d:'æ­èˆ¹è³æµ·è•æ´',loc:'Blue Grotto Malta', coords: c(35.820, 14.453), desc:'èˆ¹ç¥¨ç´„ â‚¬8ï¼Œæ™¯è‰²çµ•ç¾ã€‚'},
                {type: 'trans', mode: 'Car', ti:'å¾€ä¸‰å§å¦¹åŸ', d:'Uber / Bolt', detail:'å‰å¾€ Vittoriosaã€‚', icon:'ğŸš—'},
                {type: 'visit', tm:'PM',ti:'ä¸‰å§å¦¹åŸ (Three Cities)',d:'Vittoriosa, Senglea, Cospicua',loc:'The Three Cities', coords: c(35.887, 14.522), desc:'æ¯”ç“¦èŠå¡”æ›´å¤è€çš„é¨å£«åœ˜æ“šé»ã€‚'},
                {type: 'visit', tm:'Dinner',ti:'Rampila or Ta\' Kris',d:'ç“¦èŠå¡”/Sliema æ™šé¤',loc:'Rampila Restaurant', coords: c(35.896, 14.508), eat:1}
            ]},
            { id:'d9', date:'2/9', wk:'é€±ä¸€', city:'Venice', t:'8Â°', c:'Rain', tl:[
                {type: 'trans', mode: 'Flight', ti:'é£›å¾€å¨å°¼æ–¯', d:'Ryanair: MLA (17:20) -> VCE (19:15)', icon:'âœˆï¸'},
                {type: 'trans', mode: 'Bus', ti:'æ©Ÿå ´å¾€å¸‚å€', d:'Bus: VCE -> Piazzale Roma', detail:'å¾æ©Ÿå ´æ­å·´å£«åˆ°ç¾…é¦¬å»£å ´ã€‚', icon:'ğŸšŒ'},
                {type: 'trans', mode: 'Boat', ti:'å¾€é£¯åº—', d:'Vaporetto (æ°´ä¸Šå·´å£«)', detail:'è²· Rolling Venice Card (â‚¬6, 29æ­²ä»¥ä¸‹) + 3æ—¥ç¥¨ (â‚¬27)ã€‚', icon:'â›´ï¸'},
                {type: 'visit', tm:'21:00',ti:'Check-in',d:'Carnival Palace (Cannaregioå€)',loc:'Carnival Palace Hotel', coords: c(45.446, 12.320), desc:'ä½æ–¼ Tre Archi ç¢¼é ­æ—ã€‚'},
                {type: 'visit', tm:'Dinner',ti:'Agli Archi',d:'é™„è¿‘æ™šé¤',loc:'Agli Archi Venice', coords: c(45.446, 12.321), eat:1}
            ]},
            { id:'d10', date:'2/10', wk:'é€±äºŒ', city:'Venice', t:'9Â°', c:'Cloudy', tl:[
                {type: 'trans', mode: 'Boat', ti:'å¾€é‡Œäºæ‰˜', d:'Vaporetto Line 1/2', icon:'â›´ï¸'},
                {type: 'visit', tm:'AM',ti:'é‡Œäºæ‰˜æ©‹ (Rialto)',d:'å¨å°¼æ–¯åœ°æ¨™',loc:'Ponte di Rialto', coords: c(45.438, 12.335)},
                {type: 'visit', tm:'Sight',ti:'æ²‰èˆ¹æ›¸åº—',d:'Gondola è£æ›¸',loc:'Libreria Acqua Alta', coords: c(45.437, 12.342)},
                {type: 'trans', mode: 'Walk', ti:'æ­¥è¡Œ', d:'Walk to San Marco', icon:'ğŸš¶'},
                {type: 'visit', tm:'PM',ti:'è–é¦¬å¯å»£å ´',d:'å¤§æ•™å ‚ã€ç¸½ç£å®®ã€é˜æ¨“',loc:'Piazza San Marco', coords: c(45.434, 12.338), imp:1},
                {type: 'visit', tm:'Sight',ti:'è–é¦¬å¯å‘¨é‚Š',d:'é˜æ¨“(Campanile) -> æ‘©çˆ¾äººé˜å¡” -> ç¸½ç£å®® (Doge\'s Palace)',loc:'Campanile di San Marco', coords: c(45.434, 12.339)},
                {type: 'visit', tm:'Sight',ti:'å˜†æ¯æ©‹ & èŠ±ç¥å’–å•¡',d:'Ponte dei Sospiri -> CaffÃ¨ Florian',loc:'Bridge of Sighs', coords: c(45.434, 12.341)},
                {type: 'trans', mode: 'Boat', ti:'å¾€å­¸é™¢æ©‹', d:'Vaporetto to Accademia', icon:'â›´ï¸'},
                {type: 'visit', tm:'Sight',ti:'å­¸é™¢æ©‹ & ç¾è¡“é¤¨',d:'Ponte dell\'Accademia -> Gallerie dell\'Accademia',loc:'Ponte dell\'Accademia', coords: c(45.431, 12.328)},
                {type: 'visit', tm:'Shop',ti:'Despar Teatro Italia',d:'åŠ‡é™¢æ”¹å»ºçš„æœ€ç¾è¶…å¸‚',loc:'Despar Teatro Italia', coords: c(45.442, 12.329), buy:1}
            ]},
            { id:'d11', date:'2/11', wk:'é€±ä¸‰', city:'Venice', t:'8Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Boat', ti:'å¾€ç»ç’ƒå³¶', d:'Vaporetto 4.1 / 4.2 -> Murano', icon:'â›´ï¸'},
                {type: 'visit', tm:'09:00',ti:'Murano (ç»ç’ƒå³¶)',d:'åƒè§€ç»ç’ƒå·¥è—',loc:'Murano', coords: c(45.459, 12.352)},
                {type: 'trans', mode: 'Boat', ti:'å¾€å½©è‰²å³¶', d:'Vaporetto 12: Murano Faro -> Burano', icon:'â›´ï¸'},
                {type: 'visit', tm:'11:00',ti:'Burano (å½©è‰²å³¶)',d:'ç¹½ç´›æˆ¿å±‹èˆ‡è•¾çµ²',loc:'Burano', coords: c(45.485, 12.417), imp:1},
                {type: 'visit', tm:'Sight',ti:'Torcello',d:'æœ€å¤è€æ•™å ‚ (å¯é¸)',loc:'Torcello', coords: c(45.498, 12.419), desc:'æ­ä¹˜ 9 è™Ÿèˆ¹å¾ Burano å‰å¾€ã€‚'},
                {type: 'trans', mode: 'Boat', ti:'è¿”å›æœ¬å³¶', d:'Vaporetto 12', icon:'â›´ï¸'},
                {type: 'visit', tm:'Dinner',ti:'Trattoria Bar Pontini',d:'æµ·é®®ç¾©å¤§åˆ©éºµ',loc:'Trattoria Bar Pontini', coords: c(45.444, 12.325), eat:1, menu:'æµ·é®®éºµ, å¢¨é­šéºµ'}
            ]},
            { id:'d12', date:'2/12', wk:'é€±å››', city:'Florence', t:'11Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Train', ti:'å¾€ä½›ç¾…å€«æ–¯', d:'Italo 8911: Venezia SL (11:05) -> Firenze SMN (13:20)', icon:'ğŸš„'},
                {type: 'visit', tm:'Check-in',ti:'Piazza della Stazione',d:'å…¬å¯“ Check-in',loc:'Piazza della Stazione 1 Firenze', coords: c(43.776, 11.248)},
                {type: 'visit', tm:'Lunch',ti:'Trattoria ZÃ  ZÃ ',d:'å¿…åƒä¸éª¨ç‰›æ’',loc:'Trattoria ZÃ  ZÃ ', coords: c(43.776, 11.253), eat:1, menu:'Bistecca alla Fiorentina (1kg)'},
                {type: 'trans', mode: 'Bus', ti:'å¾€ Fiesole', d:'Bus 7', detail:'ç´„ 30-40 åˆ†é˜ã€‚', icon:'ğŸšŒ'},
                {type: 'visit', tm:'PM',ti:'Fiesole å±±åŸ',d:'ä¿¯ç°ä½›ç¾…å€«æ–¯å…¨æ™¯',loc:'Fiesole', coords: c(43.807, 11.294)}
            ]},
            { id:'d13', date:'2/13', wk:'é€±äº”', city:'Florence', t:'12Â°', c:'Cloudy', tl:[
                {type: 'visit', tm:'Lunch',ti:'Da Nerbone',d:'ä¸­å¤®å¸‚å ´ç‰›è‚šåŒ…',loc:'Mercato Centrale Firenze', coords: c(43.776, 11.253), eat:1, menu:'Lampredotto, Bollito'},
                {type: 'visit', tm:'PM',ti:'ç™¾èŠ±å¤§æ•™å ‚ (Duomo)',d:'ç™»é ‚ (Brunelleschi Pass)',loc:'Santa Maria del Fiore', coords: c(43.773, 11.255), imp:1},
                {type: 'visit', tm:'Shop',ti:'Pegna dal 1860',d:'ç™¾å¹´é›œè²¨è¡Œ',loc:'Pegna dal 1860', coords: c(43.771, 11.256), buy:1},
                {type: 'trans', mode: 'Walk', ti:'æ­¥è¡Œ', d:'Walk to Ponte Vecchio', icon:'ğŸš¶'},
                {type: 'visit', tm:'Sight',ti:'è€æ©‹ (Ponte Vecchio)',d:'é‡‘é£¾åº—å¤æ©‹',loc:'Ponte Vecchio', coords: c(43.768, 11.253)},
                {type: 'visit', tm:'Shop',ti:'Giunti Odeon',d:'æ›¸åº—é›»å½±é™¢',loc:'Giunti Odeon', coords: c(43.771, 11.251), buy:1}
            ]},
            { id:'d14', date:'2/14', wk:'é€±å…­', city:'Florence', t:'12Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Train', ti:'å¾€æ¯”è–©', d:'Regionale: Firenze SMN (09:53) -> Pisa S. Rossore', detail:'ä¸‹è»Šæ­¥è¡Œ 5 åˆ†é˜å³é”æ–œå¡”ã€‚', icon:'ğŸš†'},
                {type: 'visit', tm:'AM',ti:'æ¯”è–©æ–œå¡”',d:'å¥‡è¹Ÿå»£å ´æ‹ç…§',loc:'Leaning Tower of Pisa', coords: c(43.722, 10.396), imp:1},
                {type: 'visit', tm:'Lunch',ti:'Cantina Vasari',d:'æ¯”è–©åˆé¤',loc:'Cantina Vasari', coords: c(43.721, 10.400), eat:1},
                {type: 'trans', mode: 'Train', ti:'è¿”å›ä½›ç¾…å€«æ–¯', d:'Regionale: Pisa -> Firenze SMN', icon:'ğŸš†'},
                {type: 'visit', tm:'Snack',ti:'Vivoli',d:'çŸ¥å Gelato',loc:'Vivoli', coords: c(43.769, 11.261), eat:1, menu:'Affogato'},
                {type: 'visit', tm:'Dinner',ti:'Osteria Pastella',d:'è»Šè¼ªèµ·å¸æ¾éœ²éºµ',loc:'Osteria Pastella', coords: c(43.773, 11.248), eat:1}
            ]},
            { id:'d15', date:'2/15', wk:'é€±æ—¥', city:'Rome', t:'13Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Train', ti:'å¾€ç¾…é¦¬', d:'Italo 8903: Firenze SMN (09:28) -> Roma Termini (11:05)', icon:'ğŸš„'},
                {type: 'trans', mode: 'Metro', ti:'å¾€é£¯åº—', d:'Metro A: Termini -> Barberini/Spagna', detail:'è³¼è²· BIT å–®ç¨‹ç¥¨ (â‚¬1.5) æˆ– Multi-BITã€‚', icon:'ğŸš‡'},
                {type: 'visit', tm:'Check-in',ti:'Spagna Apt',d:'è¿‘è¥¿ç­ç‰™å»£å ´',loc:'Via dei Due Macelli 31', coords: c(41.904, 12.483)},
                {type: 'visit', tm:'Snack',ti:'Pompi TiramisÃ¹',d:'å¿…åƒææ‹‰ç±³è˜‡',loc:'Pompi TiramisÃ¹', coords: c(41.904, 12.480), eat:1},
                {type: 'visit', tm:'PM',ti:'è¥¿ç­ç‰™å»£å ´',d:'ç¾…é¦¬å‡æœŸå ´æ™¯',loc:'Piazza di Spagna', coords: c(41.905, 12.482), imp:1},
                {type: 'visit', tm:'Dinner',ti:'Dar Bruttone',d:'ç¾…é¦¬é¢¨å‘³æ™šé¤',loc:'Dar Bruttone', coords: c(41.884, 12.503), eat:1}
            ]},
            { id:'d16', date:'2/16', wk:'é€±ä¸€', city:'Rome', t:'14Â°', c:'Sunny', tl:[
                {type: 'trans', mode: 'Metro', ti:'å¾€ç«¶æŠ€å ´', d:'Metro B: Termini -> Colosseo', icon:'ğŸš‡'},
                {type: 'visit', tm:'13:20',ti:'ç¾…é¦¬ç«¶æŠ€å ´',d:'é ç´„ Arena Floor',loc:'Colosseum', coords: c(41.890, 12.492), imp:1, desc:'é€²å…¥ä¸­å¿ƒæ„Ÿå—è§’é¬¥å£«è¦–è§’ã€‚åŒ…å«å¤ç¾…é¦¬å»£å ´ (Foro Romano)ã€‚'},
                {type: 'trans', mode: 'Bus', ti:'å¾€è¨±é¡˜æ± ', d:'Bus / Walk', icon:'ğŸšŒ'},
                {type: 'visit', tm:'PM',ti:'è¨±é¡˜æ±  (Fontana di Trevi)',d:'ä¸Ÿç¡¬å¹£è¨±é¡˜',loc:'Trevi Fountain', coords: c(41.900, 12.483), imp:1},
                {type: 'visit', tm:'Dinner',ti:'CiPASSO',d:'é«˜äººæ°£é¤é…’é¤¨',loc:'CiPASSO Vineria Bistrot', coords: c(41.900, 12.470), eat:1, menu:'Carbonara, Octopus'}
            ]},
            { id:'d17', date:'2/17', wk:'é€±äºŒ', city:'Rome', t:'14Â°', c:'Cloudy', tl:[
                {type: 'trans', mode: 'Metro', ti:'å¾€æ¢µè’‚å²¡', d:'Metro A -> Ottaviano', icon:'ğŸš‡'},
                {type: 'visit', tm:'14:00',ti:'æ¢µè’‚å²¡åšç‰©é¤¨',d:'è¥¿æ–¯æ±€ç¦®æ‹œå ‚',loc:'Vatican Museums', coords: c(41.906, 12.453), imp:1},
                {type: 'visit', tm:'16:30',ti:'è–å½¼å¾—å¤§æ•™å ‚',d:'ä¸–ç•Œæœ€å¤§æ•™å ‚',loc:'St. Peter\'s Basilica', coords: c(41.902, 12.454)},
                {type: 'visit', tm:'18:00',ti:'è–å¤©ä½¿å ¡',d:'æ‹æ”å¤©ä½¿æ©‹',loc:'Castel Sant\'Angelo', coords: c(41.903, 12.466)},
                {type: 'visit', tm:'Sight',ti:'ç´æ²ƒç´å»£å ´ (Piazza Navona)',d:'å››æ²³å™´æ³‰',loc:'Piazza Navona', coords: c(41.899, 12.473)},
                {type: 'visit', tm:'Sight',ti:'è¬ç¥æ®¿ (Pantheon)',d:'ç¾…é¦¬ç©¹é ‚',loc:'Pantheon', coords: c(41.898, 12.476)},
                {type: 'visit', tm:'Coffee',ti:'é‡‘æ¯å’–å•¡ (Tazza d\'Oro)',d:'è¬ç¥æ®¿æ—å¿…å–',loc:'Tazza d\'Oro', coords: c(41.899, 12.476), eat:1, menu:'Coffee Granita'}
            ]},
            { id:'d18', date:'2/18', wk:'é€±ä¸‰', city:'Rome', t:'13Â°', c:'Rain', tl:[
                {type: 'visit', tm:'Lunch',ti:'Rome SupplÃ¬ & Piccolo Buco',d:'ç‚¸é£¯ç³°èˆ‡è¶…äººæ°£ Pizza',loc:'Piccolo Buco', coords: c(41.900, 12.483), eat:1},
                {type: 'trans', mode: 'Train', ti:'å¾€æ©Ÿå ´', d:'Leonardo Express: Termini -> FCO', detail:'ç¥¨åƒ¹ â‚¬14ï¼Œè»Šç¨‹ 32 åˆ†é˜ã€‚', icon:'ğŸš„'},
                {type: 'visit', tm:'20:50',ti:'FCO â†’ DXB',d:'Emirates è¿”ç¨‹',loc:'Fiumicino Airport Terminal 3', coords: c(41.793, 12.251), l:[{t:'Emirates',u:'https://www.emirates.com/'}]}
            ]},
            { id:'d19', date:'2/19', wk:'é€±å››', city:'Taipei', t:'21Â°', c:'Cloudy', tl:[
                {type: 'visit', tm:'20:40',ti:'æŠµé”å°åŒ—',d:'æ—…ç¨‹çµæŸï¼',loc:'Taoyuan Airport', coords: c(25.079, 121.234)}
            ]}
        ];

        const FLIGHTS = [
            {t:'1/31 Â· TPE â†’ DXB',v:'23:00',n:'Emirates EK367', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}, 
            {t:'2/1 Â· DXB â†’ CDG',v:'12:25',n:'Emirates EK073 (Arr T2C)', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'},
            {t:'2/5 Â· CDG â†’ MLA',v:'10:00',n:'EasyJet (Dep T2B)', u:'https://www.easyjet.com/'}, 
            {t:'2/9 Â· MLA â†’ VCE',v:'17:20',n:'Ryanair', u:'https://www.ryanair.com/'},
            {t:'2/18 Â· FCO â†’ DXB',v:'20:50',n:'Emirates (Dep T3)', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}, 
            {t:'2/19 Â· DXB â†’ TPE',v:'20:40',n:'Arr Taipei'}
        ];

        const HOTELS = [
            {t:'Paris',v:'Apartment',d:'15 Rue des Halles',n:'Booking',l:'15 Rue des Halles', dt:'2/1 - 2/5 (4æ™š)', u:'https://www.booking.com'},
            {t:'Malta',v:'Sliema Apt',d:'47 TignÃ© Seafront',n:'Booking',l:'47 TignÃ© Seafront', dt:'2/5 - 2/9 (4æ™š)', u:'https://www.booking.com'},
            {t:'Venice',v:'Carnival Palace',d:'Cannaregio, 929',n:'Agoda',l:'Carnival Palace Hotel', dt:'2/9 - 2/12 (3æ™š)', u:'https://www.agoda.com'},
            {t:'Florence',v:'Station Apt',d:'Piazza della Stazione',n:'Booking',l:'Piazza della Stazione 1 Firenze', dt:'2/12 - 2/15 (3æ™š)', u:'https://www.booking.com'},
            {t:'Rome',v:'Spagna Apt',d:'Via dei Due Macelli',n:'Agoda',l:'Via dei Due Macelli 31 Roma', dt:'2/15 - 2/18 (3æ™š)', u:'https://www.agoda.com'}
        ];

        const AI_STORAGE_KEY = 'trip2026_ai_data';
        const API_KEY_STORAGE_KEY = 'trip2026_gemini_key';

        // --- App Component ---
        function App() {
            // Helper to get Today's Trip ID
            const getTodayId = () => {
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                const match = TRIP.find(d => d.date === dateStr);
                return match ? match.id : 'd0'; // Default to first day if not found so you can see the effect
            };

            const [currentTab, setCurrentTab] = useState('trip'); // Default to Trip tab
            const [expandedDayId, setExpandedDayId] = useState(getTodayId()); // Auto expand today
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showApiModal, setShowApiModal] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [weatherModal, setWeatherModal] = useState({ visible: false, city: null, loading: false, data: null, error: false });
            const [aiData, setAiData] = useState(null);
            const [apiKey, setApiKey] = useState('');
            const [isFetchingAi, setIsFetchingAi] = useState(false);
            const [userLocation, setUserLocation] = useState(null); // GPS State

            useEffect(() => {
                try {
                    const storedAi = localStorage.getItem(AI_STORAGE_KEY);
                    if (storedAi) setAiData(JSON.parse(storedAi));
                    const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                    if (storedKey) setApiKey(storedKey);
                } catch (e) { console.log('Storage access failed'); }

                // Initial GPS fetch
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setUserLocation({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => { console.log("GPS access denied or error", error); },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                }
            }, []);

            useEffect(() => { window.scrollTo(0, 0); }, [currentTab]);

            const showToastMessage = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            };

            const toggleInstallGuide = () => setShowInstallModal(!showInstallModal);
            const toggleApiModal = () => setShowApiModal(!showApiModal);
            
            const saveApiKeyFunc = (keyInput) => {
                const key = keyInput.trim();
                if (key) {
                    try { localStorage.setItem(API_KEY_STORAGE_KEY, key); } catch(e) {
                        showToastMessage("ç„¡æ³•å„²å­˜ Key");
                        return;
                    }
                    setApiKey(key);
                    toggleApiModal();
                    showToastMessage("Key å·²å„²å­˜ï¼");
                    if(currentTab === 'guide') fetchAiGuide(getCurrentCity(), true, key);
                } else {
                    showToastMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key");
                }
            };

            const toggleDay = (id) => setExpandedDayId(expandedDayId === id ? null : id);

            const openWeather = (city, e) => {
                if(e) e.stopPropagation();
                setWeatherModal({ visible: true, city, loading: true, data: null, error: false });
                const coords = CITY_COORDS[city];
                if(!coords) { setWeatherModal({ visible: true, city, loading: false, data: null, error: true }); return; }
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`)
                    .then(res => res.json()).then(data => setWeatherModal(prev => ({ ...prev, loading: false, data: data })))
                    .catch(() => setWeatherModal(prev => ({ ...prev, loading: false, error: true })));
            };

            const closeWeather = () => setWeatherModal(prev => ({ ...prev, visible: false }));

            const getCurrentCity = () => {
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                const match = TRIP.find(d => d.date === dateStr);
                return match ? match.city : 'Europe';
            };

            const fetchAiGuide = async (city, force = false, keyOverride = null) => {
                if (isFetchingAi && !force) return;
                setIsFetchingAi(true);
                const keyToUse = keyOverride || apiKey;
                if (!keyToUse) { setIsFetchingAi(false); return; }

                // Update GPS if possible before fetching
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (p) => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }),
                        (e) => console.log(e)
                    );
                }

                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                const todayItinerary = TRIP.find(d => d.date === dateStr);
                
                let itineraryContext = "No specific itinerary data found for today.";
                if (todayItinerary && todayItinerary.tl) {
                    itineraryContext = todayItinerary.tl
                        .filter(item => item.type === 'visit')
                        .map(item => `- ${item.tm || ''} ${item.ti}: ${item.d} (Location: ${item.loc})`)
                        .join('\n');
                }

                let gpsContext = "User GPS location is unknown.";
                if (userLocation) {
                    gpsContext = `User is currently at GPS coordinates: ${userLocation.lat}, ${userLocation.lng}.`;
                }

                const prompt = `You are a professional local tour guide in ${city}.
                
                CONTEXT:
                1. Date: ${dateStr} (Today)
                2. ${gpsContext}
                3. Itinerary for today:
                ${itineraryContext}

                TASK:
                Provide a detailed, high-value daily guide in Traditional Chinese (ç¹é«”ä¸­æ–‡).
                
                CRITICAL INSTRUCTION FOR NAVIGATION:
                For every recommended location (Restaurant or Shop), you MUST append this exact HTML string at the end of its description, replacing {LocationName} with the specific place name:
                
                <br><a href='https://www.google.com/maps/search/?api=1&query={LocationName}' target='_blank' class='inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-[#E5F2FF] dark:bg-[#007AFF]/20 text-[#007AFF] dark:text-[#0A84FF] text-[13px] font-semibold no-underline mt-2 transition-colors hover:bg-[#D1E8FF]'><svg width='14' height='14' viewBox='0 0 24 24' fill='currentColor'><polygon points='3 11 22 2 13 21 11 13 3 11'/></svg> å°èˆª</a>

                Format:
                [Part 1: Daily Briefing & Outfit] ||| [Part 2: Real-time Transport Guide] ||| [Part 3: Must Eat List] ||| [Part 4: Must Buy List]

                Content Requirements:
                Part 1: Daily Briefing
                - Weather outfit advice for today.
                - 1-2 Specific hacks for today's specific spots.

                Part 2: Real-time Transport Guide
                - If GPS is available, tell the user how to get from their CURRENT location to the first itinerary spot.
                - Explain how to move between the itinerary spots.

                Part 3: Must Eat List
                - List EXACTLY 5 food items or restaurants near the itinerary.
                - **IMPORTANT:** Append the HTML navigation button code after each item.

                Part 4: Must Buy List
                - List EXACTLY 5 items or shops near the itinerary.
                - **IMPORTANT:** Append the HTML navigation button code after each item.

                Keep descriptions concise. Do not output Markdown headers like "# Part 1".`;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 25000); 
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(response.statusText);
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        const content = data.candidates[0].content.parts[0].text;
                        const saveData = { date: new Date().toLocaleDateString(), city: city, content: content };
                        setAiData(saveData);
                        try { localStorage.setItem(AI_STORAGE_KEY, JSON.stringify(saveData)); } catch(e){}
                    } else { throw new Error('No content'); }
                } catch (error) {
                    showToastMessage("é€£ç·šä¸ç©©æˆ– GPS ç²å–å¤±æ•—ï¼Œå·²è¼‰å…¥é›¢ç·šæ”»ç•¥");
                    const mockContent = `**ğŸŒ¤ï¸ å¤©æ°£èˆ‡ç©¿æ­**\n${city} æ—©æ™šæº«å·®å¤§ï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚\n\n**ğŸ’¡ è¡Œç¨‹å°æ’‡æ­¥**\né¿é–‹å°–å³°æ™‚æ®µç”¨é¤ã€‚\n|||**ğŸš— äº¤é€šå»ºè­° (é›¢ç·šæ¨¡å¼)**\nç„¡æ³•å–å¾— GPS å®šä½ã€‚è«‹ä½¿ç”¨ Google Maps æŸ¥è©¢æœ€ä½³è·¯ç·šã€‚\n\nè¡Œç¨‹é–“äº¤é€šï¼š\n${itineraryContext}\n|||**ğŸ½ï¸ å¿…åƒç¾é£Ÿ (è¡Œç¨‹é™„è¿‘)**\n1. ç•¶åœ°ç‰¹è‰²å°åƒ - å°±åœ¨æ™¯é»æ—ã€‚\n2. å¿…åƒç”œé» - æ­¥è¡Œ5åˆ†é˜ã€‚\n3. äººæ°£å’–å•¡å»³ - è½‰è§’å³é”ã€‚\n4. å‚³çµ±å¸‚å ´ç¾é£Ÿ - é«”é©—ç•¶åœ°ç”Ÿæ´»ã€‚\n5. éš±è—ç‰ˆæ™šé¤ - éœ€æå‰é ç´„ã€‚\n|||**ğŸ›ï¸ å¿…è²·å¥½ç‰© (è¡Œç¨‹é™„è¿‘)**\n1. ç‰¹è‰²ç´€å¿µå“ - æ™¯é»å•†åº—ã€‚\n2. æ‰‹å·¥è—å“ - é™„è¿‘å··å¼„ã€‚\n3. ç•¶åœ°é›¶é£Ÿ - è¶…å¸‚å¯è²·ã€‚\n4. è¨­è¨ˆå°ç‰© - æ–‡å‰µåº—ã€‚\n5. é™å®šä¼´æ‰‹ç¦® - æ©Ÿå ´ä¹Ÿæœ‰ã€‚`;
                    setAiData({ date: new Date().toLocaleDateString(), city: city, content: mockContent });
                } finally { setIsFetchingAi(false); }
            };

            return (
                <div className="bg-[#F2F2F7] dark:bg-black text-black dark:text-white transition-colors duration-300 min-h-screen font-sans flex flex-col">
                    {/* Toast */}
                    <div id="toast" className={`fixed top-14 left-1/2 -translate-x-1/2 z-[100] bg-white/50 dark:bg-[#2C2C2E]/90 backdrop-blur-md text-black dark:text-white px-6 py-3 rounded-full text-[15px] font-medium shadow-2xl transition-all duration-300 flex items-center gap-2 ${toast.show ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 -translate-y-4 scale-95 pointer-events-none'}`}>
                        {toast.message}
                    </div>

                    {/* Header */}
                    <div className="sticky top-0 z-40 bg-[#F2F2F7]/80 dark:bg-black/80 backdrop-blur-xl border-b border-black/5 dark:border-white/10 safe-top">
                        <div className="px-5 pt-4 pb-3 flex justify-between items-end">
                            <div>
                                <h1 className="text-[34px] font-bold tracking-tight text-black dark:text-white leading-tight">Trip 2026</h1>
                                <p className="text-[13px] font-medium text-gray-500 dark:text-gray-400 mt-0.5 uppercase tracking-wide">Jan 31 - Feb 19 Â· 19 Days</p>
                            </div>
                            <button onClick={toggleInstallGuide} className="w-8 h-8 rounded-full bg-gray-200/50 dark:bg-white/10 flex items-center justify-center active:scale-90 transition-transform">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#007AFF" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
                            </button>
                        </div>
                    </div>

                    {/* Main */}
                    <main className="px-4 py-4 max-w-lg mx-auto w-full flex-grow safe-pb-with-margin">
                        {currentTab === 'today' && <RenderToday switchTab={setCurrentTab} userLocation={userLocation} />}
                        {currentTab === 'trip' && <RenderTrip expandedDayId={expandedDayId} toggleDay={toggleDay} openWeather={openWeather} userLocation={userLocation} />}
                        {currentTab === 'info' && <RenderInfo />}
                        {currentTab === 'guide' && <RenderGuide apiKey={apiKey} toggleApiModal={toggleApiModal} aiData={aiData} isFetching={isFetchingAi} fetchAiGuide={fetchAiGuide} getCurrentCity={getCurrentCity} userLocation={userLocation} />}
                    </main>

                    {/* Tab Bar - Adjusted for iPhone 14/17 Pro Max Home Bar */}
                    <div className="fixed left-1/2 -translate-x-1/2 w-[90%] max-w-[380px] h-[64px] bg-white/10 dark:bg-[#1C1C1E]/50 backdrop-blur-xl border border-white/20 dark:border-white/10 shadow-2xl rounded-[32px] p-1.5 flex items-center justify-between z-50 safe-bottom-pos">
                        <TabButton id="today" label="ç¸½è¦½" icon={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="trip" label="è¡Œç¨‹" icon={<><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="info" label="è³‡è¨Š" icon={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="guide" label="AI æ”»ç•¥" icon={<><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></>} currentTab={currentTab} setTab={setCurrentTab} isAi={true} />
                    </div>

                    {/* Modals */}
                    {showInstallModal && <InstallModal toggle={toggleInstallGuide} />}
                    {showApiModal && <ApiModal toggle={toggleApiModal} onSave={saveApiKeyFunc} />}
                    {weatherModal.visible && <WeatherModal modal={weatherModal} close={closeWeather} />}
                </div>
            );
        }

        // --- Helpers & Sub-Components ---
        // Haversine formula to calculate distance
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        function ApiInput({ onSave }) {
            const inputRef = useRef(null);
            return (
                <>
                    <input ref={inputRef} type="password" placeholder="è²¼ä¸Š API Key" className="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-800 mb-4 outline-none border-2 border-transparent focus:border-[#007AFF] dark:text-white transition-all text-[15px]" />
                    <div className="flex gap-3">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="flex-1 py-3.5 text-center rounded-xl bg-gray-100 dark:bg-gray-800 text-[15px] font-semibold text-gray-500 active:scale-95 transition-transform">å–å¾— Key</a>
                        <button onClick={() => onSave(inputRef.current.value)} className="flex-[2] py-3.5 rounded-xl bg-[#007AFF] text-white font-semibold text-[15px] shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">å„²å­˜ä¸¦å•Ÿå‹•</button>
                    </div>
                </>
            );
        }

        function TabButton({ id, label, icon, currentTab, setTab, isAi }) {
            const isActive = currentTab === id;
            let strokeColor = 'currentColor';
            if (isActive) strokeColor = isAi ? '#AF52DE' : '#007AFF';
            return (
                <button onClick={() => setTab(id)} className={`flex-1 h-full rounded-[26px] flex flex-col items-center justify-center gap-1 transition-all duration-300 ${isActive ? 'bg-white dark:bg-[#2C2C2E] shadow-[0_2px_12px_rgba(0,0,0,0.08)]' : 'opacity-40 hover:opacity-60'}`}>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={strokeColor} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icon}</svg>
                    <span className={`text-[10px] font-semibold tracking-wide ${isActive ? (isAi ? 'text-purple-500' : 'text-[#007AFF] dark:text-[#0A84FF]') : ''}`}>{label}</span>
                </button>
            );
        }

        function RenderToday({ switchTab, userLocation }) {
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
            const todayData = TRIP.find(d => d.date === dateStr);
            const tripStart = new Date(2026, 0, 31);
            if (todayData) {
                const todayFlight = FLIGHTS.find(f => f.t.startsWith(dateStr));
                const currentHotel = HOTELS.find(h => h.t === todayData.city);
                return (
                    <div className="space-y-6 pb-24 animate-in fade-in">
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-[#007AFF] to-[#AF52DE]"></div>
                            <h2 className="text-[13px] font-bold text-gray-400 uppercase tracking-widest mb-1">{todayData.date} Â· {todayData.wk}</h2>
                            <h1 className="text-[42px] font-bold dark:text-white mb-6 tracking-tight">{todayData.city}</h1>
                            <button onClick={() => switchTab('guide')} className="w-full py-3.5 rounded-[14px] bg-gray-50 dark:bg-[#2C2C2E] text-[#AF52DE] text-[15px] font-semibold flex items-center justify-center gap-2 active:bg-gray-100 dark:active:bg-gray-700 transition-colors">âœ¨ æŸ¥çœ‹ä»Šæ—¥ AI æ”»ç•¥<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                        </div>
                        <WeatherWidget city={todayData.city} userLocation={userLocation} />
                        {todayFlight && (
                            <div>
                                <h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä»Šæ—¥èˆªç­</h3>
                                <div className="bg-[#1C1C1E] text-white rounded-[22px] p-5 shadow-xl relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-6 relative z-10"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">âœˆï¸</div><div><div className="text-[17px] font-bold">{todayFlight.n.split(' ')[0]}</div><div className="text-[13px] text-gray-400 font-medium">{todayFlight.n.split(' ').slice(1).join(' ')}</div></div></div><div className="text-right"><div className="text-[11px] font-bold text-[#30D158] bg-[#30D158]/20 px-2 py-0.5 rounded text-center mb-1">ON TIME</div></div></div>
                                    <div className="flex justify-between items-end relative z-10"><div><div className="text-[13px] text-gray-400 mb-0.5">Time</div><div className="text-[28px] font-medium leading-none">{todayFlight.v}</div></div><div className="text-right"><div className="text-[13px] text-gray-400 mb-0.5">Date</div><div className="text-[17px] font-medium leading-none">{todayFlight.t.split(' Â· ')[0]}</div></div></div>
                                    {todayFlight.u && <a href={todayFlight.u} target="_blank" rel="noreferrer" className="mt-5 block w-full py-3 bg-white text-black text-center rounded-[12px] text-[15px] font-bold hover:bg-gray-100 transition-colors">å‰å¾€å ±åˆ° / æŸ¥çœ‹å‹•æ…‹</a>}
                                </div>
                            </div>
                        )}
                        {currentHotel && (
                            <div>
                                <h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä½å®¿</h3>
                                <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-5 shadow-sm active:scale-[0.99] transition-transform">
                                    <div className="flex justify-between items-start"><div><div className="text-[17px] font-bold dark:text-white leading-snug">{currentHotel.v}</div><div className="text-[15px] text-gray-500 mt-1">{currentHotel.d}</div><div className="flex gap-3 mt-3"><a href={`https://maps.google.com/?q=${encodeURIComponent(currentHotel.l)}`} target="_blank" rel="noreferrer" className="h-8 px-3 rounded-full bg-blue-50 dark:bg-blue-500/10 text-[#007AFF] text-[13px] font-semibold flex items-center gap-1.5"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>å°èˆª</a>{currentHotel.u && <a href={currentHotel.u} target="_blank" rel="noreferrer" className="h-8 px-3 rounded-full bg-orange-50 dark:bg-orange-500/10 text-orange-500 text-[13px] font-semibold flex items-center gap-1.5">è¨‚å–®è©³æƒ…</a>}</div></div><div className="text-[11px] font-bold bg-gray-100 dark:bg-[#2C2C2E] text-gray-500 dark:text-gray-300 px-2 py-1 rounded-md">{currentHotel.dt}</div></div>
                                </div>
                            </div>
                        )}
                        <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä»Šæ—¥è¡Œç¨‹</h3><div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] px-2 py-2 shadow-sm">{todayData.tl.map((e, idx) => (<TimelineItem key={idx} e={e} isLast={idx === todayData.tl.length - 1} userLocation={userLocation} />))}</div></div>
                    </div>
                );
            } else {
                const diffTime = tripStart - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? (
                    <div className="flex flex-col items-center justify-center h-[70vh] text-center"><div className="w-24 h-24 rounded-full bg-gray-100 dark:bg-[#1C1C1E] flex items-center justify-center text-5xl mb-8 shadow-sm">âœˆï¸</div><h2 className="text-gray-500 dark:text-gray-400 text-[15px] font-medium mb-2">è·é›¢å‡ºç™¼é‚„æœ‰</h2><div className="text-7xl font-bold dark:text-white mb-4 tracking-tighter">{diffDays}<span className="text-2xl font-medium ml-2 text-gray-400">å¤©</span></div><p className="text-[15px] text-gray-400">Jan 31, 2026 Â· Taipei â” Dubai</p></div>
                ) : (
                    <div className="flex flex-col items-center justify-center h-[70vh] text-center opacity-50"><div className="text-5xl mb-4">ğŸ‘‹</div><h2 className="text-2xl font-bold dark:text-white">æ—…ç¨‹å·²çµæŸ</h2><p className="text-[15px] text-gray-500 mt-2">æœŸå¾…ä¸‹ä¸€æ¬¡çš„å†’éšªï¼</p></div>
                );
            }
        }

        function WeatherWidget({ city, userLocation }) {
            const [data, setData] = useState(null);
            const [error, setError] = useState(false);
            const [isGps, setIsGps] = useState(false);

            useEffect(() => {
                let url = '';
                if (userLocation) {
                    url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`;
                    setIsGps(true);
                } else {
                    const coords = CITY_COORDS[city];
                    if(!coords) return;
                    url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`;
                    setIsGps(false);
                }
                
                fetch(url).then(res => res.json()).then(data => setData(data)).catch(() => setError(true));
            }, [city, userLocation]);

            if (error) return <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 text-center text-gray-500">å¤©æ°£è¼‰å…¥å¤±æ•—</div>;
            if (!data) return <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-8 flex justify-center"><div className="animate-spin h-8 w-8 border-4 border-[#007AFF] border-t-transparent rounded-full"></div></div>;
            const current = data.current;
            const daily = data.daily;
            const weather = getWeatherText(current.weather_code, current.is_day === 1);
            return (
                <div className="bg-gradient-to-br from-[#5AC8FA] to-[#007AFF] text-white rounded-[22px] p-6 shadow-lg relative overflow-hidden min-h-[200px]"><div className="flex justify-between items-start mb-8"><div><div className="text-[64px] font-light leading-none tracking-tight">{Math.round(current.temperature_2m)}Â°</div><div className="text-[19px] font-medium opacity-90 mt-1 flex items-center gap-1.5">{isGps && <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>} {weather.text}</div><div className="text-[15px] opacity-75 font-medium mt-1">H:{Math.round(daily.temperature_2m_max[0])}Â° L:{Math.round(daily.temperature_2m_min[0])}Â°</div></div><div className="text-[56px] drop-shadow-md">{weather.icon}</div></div><div className="grid grid-cols-2 gap-3 bg-white/10 rounded-[14px] p-4 backdrop-blur-md border border-white/10"><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">é«”æ„Ÿæ¿•åº¦</span><span className="text-[17px] font-semibold">{current.relative_humidity_2m}%</span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">é¢¨é€Ÿ</span><span className="text-[17px] font-semibold">{current.wind_speed_10m} <span className="text-[12px] font-normal">km/h</span></span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">æ—¥å‡º</span><span className="text-[15px] font-medium">{daily.sunrise[0].split('T')[1]}</span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">æ—¥è½</span><span className="text-[15px] font-medium">{daily.sunset[0].split('T')[1]}</span></div></div></div>
            );
        }

        function RenderTrip({ expandedDayId, toggleDay, openWeather, userLocation }) {
            const scrollRef = useRef(null);
            
            // Auto scroll to expanded day on initial load
            useEffect(() => {
                if (expandedDayId && scrollRef.current) {
                    const el = document.getElementById(expandedDayId);
                    if (el) {
                         setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                    }
                }
            }, []);

            return (
                <div className="space-y-4 pb-24 animate-in fade-in" ref={scrollRef}>
                    {TRIP.map(d => (
                        <div id={d.id} key={d.id} className={`bg-white dark:bg-[#1C1C1E] rounded-[22px] shadow-sm overflow-hidden transition-all duration-300 ${expandedDayId === d.id ? 'ring-2 ring-[#007AFF] ring-offset-2 ring-offset-[#F2F2F7] dark:ring-offset-black' : ''}`}>
                            <div onClick={() => toggleDay(d.id)} className="active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors cursor-pointer p-5 flex justify-between items-center"><div className="flex items-center gap-4"><div className="flex flex-col"><span className="text-[11px] font-bold text-gray-400 uppercase tracking-widest">{d.date} Â· {d.wk}</span><h2 className="text-[22px] font-bold dark:text-white leading-tight">{d.city}</h2></div><button onClick={(e) => openWeather(d.city, e)} className="flex items-center gap-1.5 bg-gray-100 dark:bg-[#2C2C2E] px-3 py-1.5 rounded-full transition-colors hover:bg-gray-200 dark:hover:bg-[#3A3A3C]"><span className="text-[13px]">{getWeatherText(d.c === 'Sunny' ? 0 : d.c === 'Rain' ? 61 : 3, true).icon}</span><span className="text-[13px] font-semibold text-gray-600 dark:text-gray-300">{d.t}</span></button></div><div className={`rotate-icon ${expandedDayId === d.id ? 'open' : ''} w-8 h-8 bg-gray-100 dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-gray-500`}><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="m9 18 6-6-6-6"/></svg></div></div>
                            <div className={`accordion-content ${expandedDayId === d.id ? 'open' : ''}`}><div className="px-5 pb-5"><div className="border-t border-gray-100 dark:border-gray-800 pt-2 relative">{d.tl.map((e, idx) => (<TimelineItem key={idx} e={e} isLast={idx === d.tl.length - 1} embedMap={true} userLocation={userLocation} />))}</div></div></div>
                        </div>
                    ))}
                    <div className="text-center py-8 text-gray-400 text-[13px] font-medium">âœˆï¸ æ—…ç¨‹çµæŸ</div>
                </div>
            );
        }

        function TimelineItem({ e, isLast, embedMap = false, userLocation }) {
            let distance = null;
            if (userLocation && e.coords) {
                const dist = getDistanceFromLatLonInKm(userLocation.lat, userLocation.lng, e.coords.lat, e.coords.lng);
                distance = dist < 1 ? `${Math.round(dist * 1000)} m` : `${dist.toFixed(1)} km`;
            }

            // Transport Block
            if (e.type === 'trans') {
                return (
                    <div className="py-2 relative pl-8">
                         {!isLast && <div className="timeline-line-dashed"></div>}
                        <div className="flex gap-4 items-center">
                            <div className="absolute left-[13px] w-6 h-6 rounded-full bg-gray-100 dark:bg-[#2C2C2E] border border-gray-200 dark:border-gray-600 flex items-center justify-center text-[12px] z-10">{e.icon || 'ğŸš—'}</div>
                            <div className="flex-1 min-w-0 bg-gray-50 dark:bg-[#2C2C2E]/50 rounded-xl px-4 py-3 border border-dashed border-gray-200 dark:border-gray-700">
                                <div className="flex justify-between items-start">
                                    <h4 className="text-[15px] font-bold text-gray-700 dark:text-gray-200">{e.ti}</h4>
                                    <span className="text-[11px] font-bold bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-1.5 py-0.5 rounded uppercase tracking-wide">{e.mode}</span>
                                </div>
                                <div className="text-[13px] font-medium text-gray-800 dark:text-gray-200 mt-1">{e.d}</div>
                                {e.detail && <div className="text-[12px] text-gray-500 mt-1 leading-relaxed">{e.detail}</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            // Normal Visit Block
            return (
                <div className="py-5 relative pl-4">
                     {!isLast && <div className="timeline-line"></div>}
                    <div className="flex gap-4 relative">
                        {/* Time Column */}
                        <div className="w-12 shrink-0 text-right pt-1 relative z-10">
                            <span className="text-[13px] font-semibold text-gray-400 tabular-nums">{e.tm}</span>
                        </div>
                        
                        {/* Content Column */}
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start">
                                <h4 className={`text-[17px] font-bold leading-snug pr-2 ${e.eat?'text-[#FF9500]':e.imp?'text-[#007AFF]':e.buy?'text-[#AF52DE]':'dark:text-white'}`}>{e.ti}</h4>
                                {e.loc && <a href={`https://maps.google.com/?q=${encodeURIComponent(e.loc)}`} target="_blank" rel="noreferrer" onClick={(ev) => ev.stopPropagation()} className="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-500/10 flex items-center justify-center shrink-0 text-[#007AFF] hover:bg-blue-100 dark:hover:bg-blue-500/20 transition-colors"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg></a>}
                            </div>
                            <p className="text-[15px] text-gray-600 dark:text-gray-300 mt-1.5 leading-relaxed">{e.d}</p>
                            
                            {distance && (
                                <div className="mt-2 inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-100 dark:bg-[#3A3A3C] text-[12px] font-medium text-gray-500 dark:text-gray-400">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>
                                    è·é›¢ {distance}
                                </div>
                            )}

                            {(e.desc || e.menu || e.tel || e.l || (embedMap && e.loc)) && (<div className="mt-4 bg-gray-50 dark:bg-[#2C2C2E] rounded-[16px] p-3.5 text-[14px] space-y-3 border border-transparent dark:border-white/5">{e.desc && <div className="text-gray-600 dark:text-gray-300 leading-relaxed">{e.desc}</div>}{e.menu && <div className="flex gap-2.5 items-start"><span className="text-[#FF9500] shrink-0 text-[16px]">ğŸ½ï¸</span><span className="text-gray-700 dark:text-gray-200 font-medium">{e.menu}</span></div>}{e.tel && <div className="flex gap-2.5 items-center"><span className="text-[#30D158] shrink-0 text-[16px]">ğŸ“</span><a href={`tel:${e.tel}`} className="text-[#007AFF] font-medium hover:underline">{e.tel}</a></div>}{e.l && <div className="flex flex-wrap gap-2 pt-1">{e.l.map((link, i) => <a key={i} href={link.u} target="_blank" rel="noreferrer" className="text-[13px] px-3 py-1.5 rounded-lg bg-white dark:bg-[#3A3A3C] border border-gray-200 dark:border-transparent dark:text-gray-200 flex items-center gap-1.5 font-medium shadow-sm active:scale-95 transition-all">ğŸ”— {link.t}</a>)}</div>}{embedMap && e.loc && (e.imp || e.eat || e.buy || e.tm.includes(':')) && (<div className="pt-2 rounded-[12px] overflow-hidden"><iframe className="map-frame w-full h-[150px] border-0" loading="lazy" referrerPolicy="no-referrer-when-downgrade" src={`https://maps.google.com/maps?q=${encodeURIComponent(e.loc)}&t=&z=15&ie=UTF8&iwloc=&output=embed`}></iframe></div>)}</div>)}</div></div>{!isLast && <div className="absolute bottom-0 right-0 w-[calc(100%-64px)] h-[0.5px] bg-gray-200 dark:bg-gray-700/50"></div>}
                </div>
            );
        }

        function RenderInfo() {
            return (
                <div className="space-y-8 pb-24 animate-in fade-in">
                    <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">èˆªç­è³‡è¨Š</h3><div className="apple-list-group">{FLIGHTS.map((f, i) => (<div key={i} className="apple-list-item px-4 py-4 flex justify-between items-center bg-white dark:bg-[#1C1C1E] active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors"><div className="dark:text-white"><div className="text-[16px] font-semibold">{f.t}</div><div className="text-[13px] text-gray-500 mt-0.5">{f.n}</div></div><div className="text-right"><div className="text-[16px] text-gray-900 dark:text-gray-200 font-medium tabular-nums">{f.v}</div>{f.u && <a href={f.u} target="_blank" rel="noreferrer" className="text-[12px] text-[#007AFF] font-medium mt-0.5 inline-block">æŸ¥çœ‹ç‹€æ…‹ â€º</a>}</div></div>))}</div></div>
                    <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä½å®¿è³‡è¨Š</h3><div className="apple-list-group">{HOTELS.map((h, i) => (<div key={i} className="apple-list-item px-4 py-4 flex justify-between items-start bg-white dark:bg-[#1C1C1E] active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors"><div><div className="flex items-center gap-2 mb-1"><div className="text-[16px] font-bold dark:text-white">{h.t}</div><div className="text-[11px] font-bold text-[#007AFF] bg-blue-50 dark:bg-blue-500/20 px-1.5 py-0.5 rounded-md">{h.dt}</div></div><div className="text-[15px] dark:text-gray-200 font-medium">{h.v}</div><div className="text-[13px] text-gray-500 mt-0.5 leading-tight">{h.d}</div><div className="flex items-center gap-3 mt-2"><div className="text-[12px] text-[#FF9500] font-medium">{h.n}</div>{h.u && <a href={h.u} target="_blank" rel="noreferrer" className="text-[12px] text-[#007AFF] font-medium flex items-center gap-1">é è¨‚é€£çµ â€º</a>}</div></div><a href={`https://maps.google.com/?q=${encodeURIComponent(h.l)}`} target="_blank" rel="noreferrer" className="w-8 h-8 rounded-full bg-gray-100 dark:bg-[#2C2C2E] flex items-center justify-center shrink-0 text-[#007AFF]"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg></a></div>))}</div></div>
                </div>
            );
        }

        function RenderGuide({ apiKey, toggleApiModal, aiData, isFetching, fetchAiGuide, getCurrentCity, userLocation }) {
            const todayStr = new Date().toLocaleDateString();
            const currentCity = getCurrentCity();
            const hasTodayData = aiData && aiData.date === todayStr && aiData.content;
            let guideGeneral = "", guideTransport = "", guideEat = "", guideShopping = "";
            if (hasTodayData) { 
                const parts = aiData.content.split('|||'); 
                guideGeneral = parts[0] || ""; 
                guideTransport = parts[1] || ""; 
                guideEat = parts[2] || "";
                guideShopping = parts[3] || ""; 
            }

            useEffect(() => {
                if(apiKey && !hasTodayData && !isFetching) { const timer = setTimeout(() => fetchAiGuide(currentCity), 500); return () => clearTimeout(timer); }
            }, [apiKey, hasTodayData, isFetching, currentCity]);

            return (
                <div className="pb-24 space-y-6 animate-in fade-in">
                    <div className="flex items-center justify-between px-2 pt-2">
                        <h2 className="text-[28px] font-bold dark:text-white tracking-tight">æ¯æ—¥æ”»ç•¥</h2>
                        {apiKey && <button onClick={() => fetchAiGuide(currentCity, true)} className="h-9 px-4 rounded-full bg-gray-100 dark:bg-[#2C2C2E] text-[13px] font-bold text-[#AF52DE] flex items-center gap-1.5 active:scale-95 transition-all"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>é‡æ–°ç”Ÿæˆ</button>}
                    </div>
                    {!apiKey ? (
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-8 text-center shadow-sm">
                            <h3 className="text-xl font-bold mb-3 dark:text-white">å•Ÿç”¨æ™ºæ…§å°éŠ</h3>
                            <p className="text-gray-500 dark:text-gray-400 text-[15px] mb-8 leading-relaxed">è¼¸å…¥æ‚¨çš„ API Keyï¼Œè®“ AI æ ¹æ“šä»Šæ—¥çš„å…·é«”è¡Œç¨‹ï¼ˆå¦‚ {currentCity} çš„æ™¯é»ï¼‰èˆ‡æ‚¨çš„å³æ™‚ GPS ä½ç½®ï¼Œç”Ÿæˆç²¾æº–çš„å¤©æ°£ã€äº¤é€šèˆ‡è³¼ç‰©æƒ…å ±ã€‚</p>
                            <button onClick={toggleApiModal} className="w-full bg-[#007AFF] text-white py-3.5 rounded-[14px] font-bold text-[15px] shadow-lg active:scale-95 transition-transform">ç«‹å³å•Ÿç”¨</button>
                        </div>
                    ) : hasTodayData ? (
                        <>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-2 mb-5"><span className="text-[11px] font-bold bg-[#AF52DE]/10 text-[#AF52DE] px-2 py-0.5 rounded">TODAY</span><span className="text-[13px] text-gray-400 font-medium">{todayStr} Â· {currentCity}</span></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-headings:text-black dark:prose-headings:text-white leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideGeneral) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-500/10 flex items-center justify-center text-xl">ğŸš‚</div><h3 className="text-[17px] font-bold dark:text-white">äº¤é€šæ”»ç•¥</h3></div>
                            {userLocation ? <div className="text-[12px] text-[#007AFF] bg-blue-50 dark:bg-blue-500/10 px-3 py-2 rounded-lg mb-4 flex items-center gap-2"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>å·²æ ¹æ“šæ‚¨çš„ GPS ä½ç½®å„ªåŒ–è·¯ç·š</div> : null}
                            <div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideTransport) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-red-50 dark:bg-red-500/10 flex items-center justify-center text-xl">ğŸ½ï¸</div><h3 className="text-[17px] font-bold dark:text-white">å¿…åƒæ¸…å–®</h3></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideEat) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-500/10 flex items-center justify-center text-xl">ğŸ›ï¸</div><h3 className="text-[17px] font-bold dark:text-white">å¿…è²·æ¸…å–®</h3></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideShopping) }}></div></div>
                        </>
                    ) : (
                        <div id="ai-loading-state" className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-10 text-center shadow-sm"><div className="animate-spin h-8 w-8 border-4 border-[#AF52DE] border-t-transparent rounded-full mx-auto mb-5"></div><p className="text-gray-500 dark:text-gray-400 text-[15px]">æ­£åœ¨ç²å– GPS ä¸¦åˆ†æä»Šæ—¥è¡Œç¨‹...</p></div>
                    )}
                </div>
            );
        }

        function InstallModal({ toggle }) { return <div className="fixed inset-0 z-[70] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={toggle}></div><div className="relative bg-white dark:bg-[#1C1C1E] p-6 rounded-[24px] max-w-sm w-full shadow-2xl scale-100 transition-transform"><div className="text-center"><div className="text-4xl mb-4">ğŸŒ</div><h3 className="text-xl font-bold mb-2 dark:text-white">å®‰è£åˆ°ä¸»ç•«é¢</h3><p className="text-[15px] text-gray-500 mb-6 leading-relaxed">éš±è—ç¶²å€åˆ—ï¼Œç²å¾—å¦‚åŒåŸç”Ÿ App çš„å…¨è¢å¹•é«”é©—ï¼š</p><ol className="text-left text-[15px] space-y-4 bg-gray-100 dark:bg-gray-800/50 p-5 rounded-xl dark:text-gray-200"><li className="flex gap-3 items-center">1. é»æ“Š Safari ä¸‹æ–¹ <svg className="inline text-[#007AFF]" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg> åˆ†äº«</li><li>2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li><li>3. é»æ“Šã€ŒåŠ å…¥ã€</li></ol></div></div></div>; }
        function ApiModal({ toggle, onSave }) { return <div className="fixed inset-0 z-[80] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/60 backdrop-blur-md" onClick={toggle}></div><div className="relative bg-white dark:bg-[#1C1C1E] p-6 rounded-[24px] max-w-sm w-full shadow-2xl"><h3 className="text-xl font-bold mb-2 dark:text-white">å•Ÿå‹•AIæ”»ç•¥</h3><p className="text-[15px] text-gray-500 mb-6">è«‹è¼¸å…¥ Google Gemini API Key ä»¥å•Ÿç”¨æ¯æ—¥è‡ªå‹•æ”»ç•¥åŠŸèƒ½ã€‚</p><ApiInput onSave={onSave} /></div></div>; }
        function WeatherModal({ modal, close }) { return <div className="fixed inset-0 z-[60] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={close}></div><div className="relative w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl bg-gradient-to-b from-[#4CA2CD] to-[#67B8E6] text-white p-8 scale-100 transition-transform"><button onClick={close} className="absolute top-5 right-5 p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><div className="flex flex-col items-center">{modal.loading && <div className="animate-spin h-8 w-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>}{!modal.loading && modal.error && <p>å¤©æ°£è¼‰å…¥å¤±æ•—</p>}{!modal.loading && modal.data && <><h2 className="text-3xl font-semibold mb-2">{modal.city}</h2><div className="text-8xl font-thin mb-1 tracking-tighter">{Math.round(modal.data.current.temperature_2m)}Â°</div><div className="text-xl opacity-90 mb-6 font-medium">{getWeatherText(modal.data.current.weather_code, true).text}</div><div className="flex gap-6 text-xl opacity-90 font-medium"><span>H: {Math.round(modal.data.daily.temperature_2m_max[0])}Â°</span><span>L: {Math.round(modal.data.daily.temperature_2m_min[0])}Â°</span></div></>}</div></div></div>; }
        
        function getWeatherText(code, isDay) {
            if(code === 0) return {icon: isDay?'â˜€ï¸':'ğŸŒ™', text:'æ™´æœ—'};
            if(code <= 3) return {icon: isDay?'â›…':'â˜ï¸', text:'å¤šé›²'};
            if(code <= 48) return {icon:'ğŸŒ«ï¸', text:'èµ·éœ§'};
            if(code <= 67) return {icon:'ğŸŒ§ï¸', text:'é›¨å¤©'};
            if(code <= 77) return {icon:'â„ï¸', text:'ä¸‹é›ª'};
            if(code <= 82) return {icon:'â›ˆï¸', text:'é›·é›¨'};
            return {icon:'ğŸŒ§ï¸', text:'é™£é›¨'};
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>